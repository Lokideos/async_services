# Проектирование системы

## Бизнес-требования и общие технические детали

Будет разработаны следующие сервисы:

- Таск-трекер - `tasks`
- Сервис аутентификации - `auth`
- Сервис аккаунтинга - `accounting`
- Сервис аналитики - `analytics`

Бэкенд для всех сервисов будет реализован на `Ruby` с использованием фреймворка `Hanami`.
Фронтэнд будет реализован с помощью библиотеки стилей `semantic-ui` и библиотеки `React`.

### tasks

Сервис `tasks` будет представлять из себя дашбоард с карточками задач. В соответствии с требованиями будет реализован
следующий функционал:

- В сервисе любой пользователь может создавать таски
- Таски должны иметь заголовок, описание и статус
- В соответствии с бизнес-требованиям стоимость тасок будет определяться сревисом `accounting`
- Необходимо релизовать кнопку для рандомного ассайна всех незакрытых задач, которая доступна администраторам и менеджерам
- Каждый сотрудник должен иметь возможность посмотреть список своих задач и отметить их как выполненные

#### Технические детали

- Аутентификация будет происходить с помощью синхронизация стейта аутентификации с сервисом `auth`. В случае если
  пользователельской сессии нет в локальном хранилище сессии будем считать, что он не авторизован и перенаправлять на
  страницу авторизации сервиса `auth`
- Для синхронизации стейта тасок с другими сервисами будет использована система реализующая `distributed commit log`.
  Например, `kafka`
- Для получения и отображения данных по цене тасок также будет использована `kafka`

#### Коммуникации

- Сервис `tasks` будет продьюсить эвенты `TaskCreated`, `TaskClosed`
- Сервис `tasks` будет Консьюмить эвенты `TaskPriceSet`, `UserLoggedIn`, `UserLoggedOut`, `UserRoleChanged`,
  `UserCreated`
- Сервис `tasks` будет перенаправлять пользователя на страницу авторизации сервиса `auth`

### auth

Сервис аутентификации. В соответствии с требованиями будет реализован следующий функционал:

- Сервис хранит и синхронизирует стейт пользовательских сессий со всеми остальными сервисами
- Сервис также хранит данные, необходимые для авторизации пользователей (роли)
- При попытке в первый раз зайти на любой сервис пользователь будет перенаправлен на страницу аутентификации
  сервиса `auth`

#### Технические детали

- При успешной аутентификации сервис будет отправлять эвент успешной авторизации в соответствующий топик в `kafka`
  для синхронизации стейта пользовательских сессий в остальных сервисах

#### Коммуникации

- Сервис `auth` будет продьюсить эвенты `UserLoggedIn`, `UserLoggedOut`, `UserRoleChanged`, `UserCreated`
- Сервис `auth` будет перенаправлять пользователя на страницу, с которой он пришел после успешной авторизации

### accounting

Сервис аккаунтинга. В соответствии с требованиями будет реализован следующий функционал:

- Аккаунтинг должен быть доступен только для менеджеров, бухгалтеров и администраторов
- Авторизация и аутентифакция должна осуществляться с помощью сервиса `auth`
- У каждого сотрудника должен быть свой персональный счет
- Сервис должен определять цену тасок и синхронизировать их с другими нужными сервисами
- На сервис также ложатся задачи расчета компенсации сотрудникам и ее выплаты
- Необходимо релизовать аудит лог, в котором будет вестись журнал всех операций аккаунтинга
- Необходимо реализовать возможность показа информации по дням

#### Технические детали

- Синхронизация цен тасок будет реализована в отдельном топике `kafka`
- Также как и в остальных сервисах стейт пользовательских сессий и аутентифкации будет храниться в отдельном
  хранилище для сервиса `accounting` и будет синхронизироваться с сервисом `auth` через отдельный топик в `kafka`
- Синхронизация всех необходимых данных для аналитики также будет реализована в отдельном топике

#### Коммуникации

- Сервис `accounting` будет продьюсить эвенты `TaskPriceSet`, `DayClosed`
- Сервис `accounting` будет Консьюмить эвенты `TaskCreated`, `TaskClosed`, `UserLoggedIn`, `UserLoggedOut`,
  `UserRoleChanged`, `UserCreated`
- Сервис `accounting` будет перенаправлять пользователя на страницу авторизации сервиса `auth`

### analytics

Сервис аналитики. В соответствии с требованиями будет реализован следующий функционал:

- Данный сервис доступен только админам
- Нужно показывать заработок топ-менеджмента
- Нужно показывать самую дорогую задачу за день/неделю/месяц

#### Технические детали

- Сервис `analytics` собирает всю нужную информацию из системи с помощью консьюмеров, которые собирают нужную
  инфорацию из `kafka`
- Несмотря на то, что данный сервис будет реализован последним всю информацию можно будет получить, взяв
  эвенты с нужным оффсетом из `kafka`
- Также как и остальные сервисы хранит свой стейт аунтентификации и авторизации и синхронизирует его с сервисом
  `auth`

#### Коммуникации

- Сервис `analytics` будет Консьюмить эвенты `TaskCreated`, `TaskPriceSet`, `TaskClosed`, `UserLoggedIn`,
  `UserLoggedOut`, `UserRoleChanged`, `UserCreated`
- Сервис `analytics` будет перенаправлять пользователя на страницу авторизации сервиса `auth`

## Concerns

Для решения проблем с сетью при записывании эвентов в топик необходимо реализовать ретраи. То же самое касается
любых проблем с отказами БД или любого другого ресурса по сети.
Для синхронных взаимодействий между сервисами будет использован
[паттерн](https://martinfowler.com/bliki/CircuitBreaker.html) `CircuitBreaker`.
Для решения проблем возникающих при межсервисном взаимодействии необходимо логировать все важные запросы, а также
необходимо внедрить хотя бы базовый
[distributed tracing](https://microservices.io/patterns/observability/distributed-tracing.html).
Пока что одной из основных проблем видится аутентификация. При выбраной схеме аутентификации необходимо гарантировать,
что после аутентификации на сервисе `auth` пользователь сможет сразу продолжить работу над нужными ему ресурсами.
Одним из вариантов решения этой проблемы будет синхронное обновление локального хранилища сессий пользователя для
текущего сервиса и асинхронное обновления для всех остальных. Можно сделать событие аутентификации пользователя
идемпотентным и на нужном нам сервисе отбрасывать его, если пользователь уже аутентифицирован с присланным токеном.
